<html>
  <head>
    <title>Motorcycle Sim</title>
    <style>
      body { margin: 0; padding: 0; }
      canvas { width: 100%; height: 100%; }
    </style>
  </head>
  <body>
    <script src="vendor/three.min.js"></script>
    
    <script>

      function Simulation(fps) {
        this.frame = this.frame.bind(this);
        this.frameTicks = 1000 / fps;
        this.frameSecs = 1 / fps;
        this.running = false;
        this.timeBuffer = 0;
        this.abortTicks = 100;
        this.callback = function() {};
        this.lastTicks = Date.now();
      }

      Simulation.prototype.start = function(callback) {
        this.callback = callback;
        this.running = true;
        requestAnimationFrame(this.frame);
      };

      Simulation.prototype.frame = function() {
        if (!this.running) return;

        var now = Date.now();
        var delta = now - this.lastTicks;
        this.lastTicks = now;

        if (delta > this.abortTicks) {
          requestAnimationFrame(this.frame);
          return;
        }

        while (delta >= this.frameTicks) {
          this.callback(this.frameSecs);
          delta -= this.frameTicks;
        }
        this.timeBuffer += delta;
        requestAnimationFrame(this.frame);
      }


      function View(container) {
        this.container = container;
        this.width = container.clientWidth;
        this.height = container.clientHeight;
        this.frame = this.frame.bind(this);
        this.scene = new THREE.Scene();
        this.renderer = new THREE.WebGLRenderer();
        
        this.mapView = new THREE.Object3D();
        this.bikeView = new THREE.Object3D();
        this.bikeCam = new THREE.PerspectiveCamera(70, this.width / this.height, 0.1, 1000);
        this.light = new THREE.DirectionalLight(0xffffff, 0.6);

        this.running = false;

        this.renderer.setSize(this.width, this.height);
        this.renderer.shadowMapEnabled = true;

        container.appendChild(this.renderer.domElement);
      }

      View.prototype.build = function(map, bike) {
        this.map = map;
        this.bike = bike;

        var texture = THREE.ImageUtils.loadTexture( "avatar.jpg" );

        var geometry = new THREE.PlaneGeometry(200, 200, 20, 20);
        geometry.applyMatrix(new THREE.Matrix4().makeRotationX( -Math.PI / 2 ));
        geometry.applyMatrix(new THREE.Matrix4().makeTranslation(200 / 2, 0, 200 / 2));
        
        var material = new THREE.MeshLambertMaterial({
          color: 0xffffff,
          wrapAround: true,
          shading: THREE.FlatShading,
          vertexColors: THREE.FaceColors,
          map: texture
        });

        var mesh = new THREE.Mesh(geometry, material);

        this.light.position.set(1, 2, 0);

        this.mapView.add(mesh);
        this.scene.add(this.mapView);
        this.scene.add(this.light);
      }

      View.prototype.start = function() {
        this.running = true;
        requestAnimationFrame(this.frame);
      };

      View.prototype.frame = function() {
        if (!this.running) return;
        this.updateBikeCam();
        this.renderer.render(this.scene, this.bikeCam);
        requestAnimationFrame(this.frame);
      };

      View.prototype.updateBikeCam = function() {
        this.bikeCam.position.copy(this.bike.position);
        this.bikeCam.position.applyMatrix4(new THREE.Matrix4().makeTranslation(0, 1, 0));
        var lookAt = this.bikeCam.position.clone().add(this.bike.direction);
        this.bikeCam.lookAt(lookAt);
      };


      function Map() {
        
      }

      Map.prototype.update = function(seconds) {

      };

      function Motorcycle() {
        this.lean = 0;
        this.direction = new THREE.Vector3(0, 0, 1);
        this.position = new THREE.Vector3(100, 0, 0);
        this.velocity = 1;
        this.acceleration = 0;
      }

      Motorcycle.prototype.update = function(seconds) {
        this.position.add(this.direction.clone().multiplyScalar(this.velocity * seconds));
        this.velocity += 0.1;
      };

      var map = new Map();
      var bike = new Motorcycle();
      var sim = new Simulation(60);      
      var view = new View(document.body);

      view.build(map, bike);

      sim.start(function frame(seconds) {
        bike.update(seconds);
        map.update(seconds);
      });

      view.start();

    </script>
  </body>
</html>